<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <title>Will Edward&#39;s Programming: perf</title>
    <link rel="stylesheet" type="text/css" href="static/style.css"/>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-27302158-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-27302158-1');
    </script>

</head>
<body>
<div class="content">
<div class="column">
    <div style="width: 90%;" class="page-link" onclick="window.location='index.html'">
    <h1>Will Edwards<br/><i>programming</i></h1>
    </div>
    <p><b>I have always loved programming</b> - its like Lego without gravity.</p>
    <p>Basic on my ZX81 graduating to assembler and Turbo Pascal during my teens.</p>
    <p>Developed phone OS software - engineer, architect, product manager - but got made irrelevant by the
        iPhone and redundant by Android.</p>
    <p style="font-size: 16pt; width:90%;">These days I mostly work with <b>data</b>, <b>big data</b> and <b><i>fitting big data onto small boxes</i></b>.</p>
</div>
<div class="posts-column column">
    <div class="page-title">
    <h1>perf</h1>
    
    

    </div>

<div class="post">
<div class="maximize-post" onclick="window.location='post/172424230628.html'"><img src="static/icons/maximize-2.svg"/></div>
<a name="172424230628">
    <h2 onclick="window.location='post/172424230628.html'">Faster searches with non-prefix fields in composite indices</h2>
</a>
<?xml version="1.0" ?><post-body><p>Here’s a horrid hack or neat trick to work around a gaping inefficiency in the MySQL
                query planner:</p><p>Imagine you have a very large table and a composite index e.g. the
                fields <i><b>A</b></i>, <i><b>B</b></i>, <i><b>C</b></i>
                and <i><b>D</b></i>.</p><p>Imagine you have a query WHERE <b><i>A</i>
                = ?</b> AND <b><i>C</i> = ?</b></p><p>MySQL will use the index
                to check all the values of <b><i>A</i></b> but dereference each row with the
                matching <b><i>A</i></b> before checking the <b><i>C</i></b>.</p><p>You
                can see what is happening using EXPLAIN SELECT by looking at the KEY and KEY_LEN columns: the index will
                be named the KEY (good so far!) and the KEY_LEN will be the max size of column <b><i>A</i></b>
                (ugh!). </p><p>If you supply a dummy clause constraining <b><i>B</i></b>
                too then you can force MySQL to check the <b><i>C</i></b> constraint before it
                dereferences any rows: SELECT … WHERE <b><i>A</i> = ?</b> AND <b><i>B</i>
                != ?</b> AND <b><i>C</i> = ?</b> (where <b><i>B</i></b>
                can be checked against some value that it can’t possibly be).</p><p>You can confirm this is
                happening by looking that the EXPLAIN SELECT again: the KEY will still be the name of the index (if it
                isn’t, you can force the index to be used with a USE INDEX clause) and the KEY_LEN will now be the
                maximum length of the <b><i>A</i></b>, <b><i>B</i></b>
                and <b><i>C</i></b> fields combined.</p><p>You can even use this
                trick to get an index used even if the very first field in the composite index is not constrained, e.g.
                WHERE <b><i>A</i> != ?</b> AND <b><i>B</i> = ?</b></p><p>This
                isn’t foolproof - you always need to benchmark with your database!  Using any index and the additional
                dereference cost compared to just doing a table scan in the first place assumes that the index is
                dramatically cheaper to walk and will dramatically reduce the number of rows that need to be
                dereferenced.  If only a tiny subset of the table needs to be dereferenced, the index will help; if a
                large proportion of the table is going to be dereferenced anyway then it’d be better to do a table scan
                from the get-go.</p><p><i>However</i>, if you have very large tables and you
                have composite keys that cover your fields but which some of the composite keys unconstrained then its
                well worth evaluating this approach which, in the right circumstances, can give orders of magnitude
                improvements.</p><p>Why doesn’t MySQL use this trick internally?  Well, it should!  If its
                already decided to use a composite ordered index for some prefix of the constrained fields, then it
                should always check all constraints it can before dereferencing any actual rows. If MySQL used this
                trick you wouldn’t have to find some impossible value to fake a check against either.</p><p>Its
                a bit harder to say if it can work out when to use a composite index when there is no prefix at all. 
                And of course it doesn’t work with hash indices.</p><p>Does MariaDB use this trick
                internally automatically?  I don’t know but I doubt it.</p><p>Does PostgreSQL?  No idea. 
                Etc.</p><p><i>If you liked this</i> you might like my recent stats on <a href="post/160628887798.html">database
                compression</a> or browse some of my <a alt="dead link: https://this blog" href="/#404">earlier
                posts</a> </p>
            </post-body>
 <button class="page-link" onclick="window.location='db.html#172424230628'">db</button>  <button class="page-link" onclick="window.location='mysql.html#172424230628'">mysql</button>  <button class="page-link" onclick="window.location='index.html#172424230628'">index</button> 

    <span class="post-metadata"><i>posted 2018-03-30</i></span>
</div>

<div class="post">
<div class="maximize-post" onclick="window.location='post/160628887798.html'"><img src="static/icons/maximize-2.svg"/></div>
<a name="160628887798">
    <h2 onclick="window.location='post/160628887798.html'">Compressing MySQL databases</h2>
</a>
<?xml version="1.0" ?><post-body><p><i>TL;DR: use TokuDB.  Always.  It massively reduces storage requirements and
                is massively faster than InnoDB, even on low end hardware.  My tables were compressed to just <b>12%</b>
                original size and that’s fairly typical.</i></p><p>A very simple structure:<br/></p><pre>CREATE
                TABLE test (<br/>      date DATE NOT NULL,<br/>      site VARCHAR(8) NOT NULL,<br/>  
                   order_id VARCHAR(64) NOT NULL,<br/>      time TIME NOT NULL,<br/>      kind ENUM(...) NOT
                NULL,<br/>      account INTEGER,<br/>      user INTEGER,<br/>      client_price
                BIGINT,<br/>      supplier_id INTEGER,<br/>      supplier_cost BIGINT,<br/>    
                 client_ref VARCHAR(32),<br/>      data JSON,<br/>      PRIMARY KEY (date, site, order_id),<br/>
                     INDEX (account, user, client_ref)
                ) DEFAULT CHARSET utf8<br/>PARTITION BY RANGE (TO_DAYS(date)) ( ...<br/></pre><p>This
                system is using the RDBMS as a document store; the order items are being flattened into a document store
                (the ‘data’ field).</p><p>The ETL is upserting order events as they are processed, using
                multi-row INSERT INTO … ON DUPLICATE KEY UPDATE …</p><p>And I’ve been
                running performance tests with some real data.  27M rows of real data, all on the same day (so all in
                the same partition).  37M upsert statements inserting or updating those 27M rows, issued in batches of
                1K-2K per multi-row statement.  This is enough rows to be able to get a grasp of upsert performance and
                extrapolate storage requirements.</p><p>The test box is an AWS t2.medium instance.  This is
                a very weak VM with 2 (virtual) CPUs and 4GB RAM.  Not normal DB fare, so performance beware.</p><p>The
                27M rows take 10.48GB uncompressed.  It takes InnoDB 10 hours to load all the data.</p><!--
                more --><p>In the old days, MySQL InnoDB offered ‘row_compression’.  This compresses individual
                rows.  This reduces disk requirements to 5.73GB (<b>45% space saved</b>).  So it halves the
                disk space!  Sadly, the test now took 15 hours instead of 10 hours.</p><p>More recently,
                MySQL introduced ‘table compression’.  (MariaDB also added it, calling it ‘page compression’; the CREATE
                TABLE syntax is infuriatingly slightly different).</p><p>Underneath, InnoDB is organized
                as ‘pages’.  This table compression intercepts these page reads and writes and, as pages are written to
                disk, they are individually compressed and written as a ‘sparse’ file.</p><p>As these InnoDB
                pages are larger than the file system pages, there is the opportunity for a ‘hole’ to be ‘punched’ in
                each InnoDB page.  Imagine an InnoDB page is 12KB, and the file system page size is 4KB.  The page may
                compress down to 1KB, meaning it only needs the first file system page (4KB),  and 8KB would be saved.
                 This example illustrates how wasteful this approach can be; there can still be a lot of slack in each
                page.  The total file-size as reported by ls is unchanged, but the actual used disk space (as shown by
                e.g. ls -s) is reduced.  Page compression compresses this table to 4.07GB (<b>61% savings</b>).
                 The bad news is that performance sinks awfully!  I aborted the run after 32 hours, as upsert speed had
                dropped to under 100 orders/sec.  I’ve seen this on MariaDB RDS and on my little t2.medium.  Its
                atrocious!</p><p><b><i>TokuDB is an alternative storage engine to InnoDB</i></b>.
                 It is nicely packaged by Percona so its very straightforward to install.</p><p>TokuDB
                compresses databases with zlib by default.  It compresses pages, but doesn’t store them as sparse files;
                instead, the total file size you see on disk is the total file size.</p><p>TokuDB with zlib
                compresses to <b>1.45GB (86% savings)</b>!  This is the same compression algorithm as InnoDB
                page compression and operating at much the same logical page level, but conferring much bigger savings
                because each ‘page’ is not rounded up to a multiple of the file system page size.</p><p>Because
                InnoDB puts the whole table (or, as in this case, partition) into a single file you cannot see how much
                of the storage is for the primary rows and how much is for secondary indexes.  TokuDB, however, has
                separate files for each index.  So in this case there are two files for the partition, and I can see
                that the 27M rows takes 1.02GB and the by-client index takes 0.44GB.</p><p>TokuDB allows you
                to specify other compression algorithms.  The weakest (thus fastest) is ‘snappy’, which is an LZ77
                compressor without entropy coding.  It compresses to 2.31GB (78% savings; same ratio rows to index).</p><p>There
                is also QuickLZ (between snappy and zlib in CPU requirements; 1.95GB; 81% savings) and LZMA (stronger
                than zlib; <b>1.23GB; 88% savings!</b>).</p><p>LZMA is a clear winner here.
                 What’s fascinating about the TokuDB though is not just its space-saving but also its performance: it
                takes<b> just 2 hours</b> to run my ETL and choice of compression algorithm has no
                noticeable effect on that!</p><p>Now the dire uncompressed InnoDB performance is perhaps the
                classic “InnoDB is not good with databases that don’t fit into RAM”.  I was using Percona packages so
                the defaults were not as mad as they used to be out-of-the-box with other linux sources, but I did up it
                to 2GB and a big log.  Configuring InnoDB optimally is like reading tea leaves and no amount of doing it
                makes me confident I’ve hit the sweat spot for any particular workload.  This upsert workload seems to
                be particularly stressful.  The t2.medium has two (virtual) CPUs, and as upsert performance dropped I
                saw ‘top’ reporting load average over 2.0 even though ETL was waiting on the DB.  Not good.</p><p>However
                the dire compressed InnoDB performance I saw repeated on a MariaDB RDS m4.2xlarge with the same
                data-set.  There’s something wrong with either InnoDB page compression, or with EBS spare file
                performance!</p><p>On the other hand, TokuDB shows how to do things properly!  The
                out-of-the-box defaults are very sane (it doesn’t use O_DIRECT; instead, it takes 50% to store
                uncompressed pages, and lets the OS cache the compressed pages in the normal file buffer cache.
                 Inspired!).  And the performance is just so stable!  On the t2.medium, which is a piddling little box,
                I saw 5000 orders/sec sustained throughout the entire run.</p><p>I think I’ve heard that
                TokuDB is marginally slower than (uncompressed) InnoDB on small tables.  And perhaps most users have
                small tables.  I don’t think there’s actually that measurable a gap when everything is tiny.  But the
                moment you go over a million rows or contemplate partitioning then I think TokuDB is the obvious choice.
                 In fact it would make a very good default.</p><p>Oh, and for kicks, try a COUNT(*) on a big
                InnoDB table.  And then go make a coffee!  TokuDB … snap!  Not based on meta-data like MyIASM
                did neither; just so much faster.</p><p>TokuDB redefines what a ‘small’ database is.  It
                moves the goalposts.  It means I can build bigger systems without scaling sideways.  I don’t get why
                everyone still uses InnoDB ;)</p>
            </post-body>
 <button class="page-link" onclick="window.location='db.html#160628887798'">db</button>  <button class="page-link" onclick="window.location='mysql.html#160628887798'">mysql</button>  <button class="page-link" onclick="window.location='index.html#160628887798'">index</button> 

    <span class="post-metadata"><i>posted 2017-05-13</i></span>
</div>

<div class="post">
<div class="maximize-post" onclick="window.location='post/53836725910.html'"><img src="static/icons/maximize-2.svg"/></div>
<a name="53836725910">
    <h2 onclick="window.location='post/53836725910.html'">What highscalability.com says about Scaling my Server</h2>
</a>
<?xml version="1.0" ?><post-body><blockquote>
                <p>Williams Edwards writes a wonderful, slow lingering tale of <a href="post/53349845356.html">Scaling my Server</a> through
                a series of rewrites to create a system that effortlessly maintains millions and millions of active
                users. The article is packed with goodness, but the result was to write in Java, use a central shardable
                server to push messages to devices, scale proportional to active users not total users, keep live data
                in RAM persist in a database, version the DB, use application level message ACKs, use
                DataInput/OutputStreams, use a faster JSON parser, there’s a  limit to the number of TLS
                connections can terminate, Java data types have a lot of overhead which limits the number you can keep
                in RAM, Java hashtables are wasteful. [<a alt="dead link: http://highscalability.com/blog/2013/6/21/stuff-the-internet-says-on-scalability-for-june-21-2013.html" href="/#404" target="_blank">src</a>]</p>
                </blockquote>
            </post-body>
 <button class="page-link" onclick="window.location='index2.html#53836725910'">index</button> 

    <span class="post-metadata"><i>posted 2013-06-25</i></span>
</div>

<div class="post">
<div class="maximize-post" onclick="window.location='post/53751799442.html'"><img src="static/icons/maximize-2.svg"/></div>
<a name="53751799442">
    <h2 onclick="window.location='post/53751799442.html'">Scaling my Server: follow-up</h2>
</a>
<?xml version="1.0" ?><post-body><p><a href="post/53349845356.html" target="_blank">Previously</a>, I described how I tried to do the simplest possible thing that
                might work and <em>didn’t</em> get away with it.  The story got some attention and
                a couple of interesting points and ideas were raised:</p>
                <p><strong>Doing it wrong</strong></p>
                <blockquote>
                <div>This is a lot of words for “I needed message queues and keep doing it wrong”
                <small>[<a alt="dead link: http://stackoverflow.com/questions/17274553/dont-use-the-database-as-a-queue" href="/#404" target="_blank">proggit</a>]</small></div>
                </blockquote>
                <p>Ooooh cheap shot, love it!  I’d be the first to raise such an objection but on deeper
                inspection I begin to wonder what we all mean by this bit of wisdom.  There’s a <a href="https://blog.engineyard.com/2011/5-subtle-ways-youre-using-mysql-as-a-queue-and-why-itll-bite-you" target="_blank">nice article</a> on it, but the alternatives really aren’t there as I
                see it; you’re stuck trying to find a queue server that is transactioned, can be queried and
                edited and has secondary indices and can do it with millions upon millions of <em>persistent</em>
                queues.</p>
                <p>If someone said that your Orders and OrderRows tables should instead be a queue per order you’d
                check their surroundings for sharp objects ;)</p>
                <p><strong>Golang</strong></p>
                <p>Quite a lot of people suggested Go for my next rewrite.  You know, I had exactly the same idea
                when I started the last rewrite and I reviewed it then.</p>
                <p>Go hadn’t reached 1.0 then but it was definitely the kind of language I like, even if
                I don’t like the syntax much.  But the big blocker was interning strings; in Go there isn’t
                a good way of making a caching system to de-dupe strings (perhaps reference counting would be needed and
                it’d be error-prone).  Worse, its one of those subjects where it seems most of the go-nuts
                crowd are completely small-picture people :(  Its unlikely to turn up soon, and without de-dupe we can’t
                fit the “PromotionCode1” group ID in RAM for each and every device.  This single
                issue was a no-go for me.</p>
                <p>But I do like Go, and hope to use it for real real soon…</p>
                <p><strong>But cool!</strong></p>
                <p>Writing about the scaling experience, and carefully reading everyone’s ideas and
                criticisms of it and trying to put myself in their position and see what they see has been really
                eye-opening.  I need to clean up my writing style!  Its been really fun to get so much feedback, and so
                much positive feedback too!  Thank you all, and I’ll keep you updated…</p>
            </post-body>
 <button class="page-link" onclick="window.location='index2.html#53751799442'">index</button> 

    <span class="post-metadata"><i>posted 2013-06-24</i></span>
</div>

<div class="post">
<div class="maximize-post" onclick="window.location='post/53349845356.html'"><img src="static/icons/maximize-2.svg"/></div>
<a name="53349845356">
    <h2 onclick="window.location='post/53349845356.html'">Scaling my Server</h2>
</a>
<?xml version="1.0" ?><post-body><p>(<a href="post/53751799442.html" target="_blank">Followup</a>.  Also  <a href="post/53836725910.html" target="_blank">highscalability.com</a>)</p>
                <p>At the beginning of the <a alt="dead link: http://www.mblox.com/" href="/#404" target="_blank">project</a>
                to build a large-scale targeted multi-recipient messaging server, I opted to use the simplest, most
                mainstream architecture possible: put everything in a RDBMS and let each web handler run queries.</p>
                <p>It is a bit like push email but with groups and you can edit and recall messages even after
                they are sent and you can schedule them and you can even make complex expressions to determine who gets
                the message and so on.  And it had to be an online system rather than a batch system.  All in all, quite
                a complex bit of software.</p>
                <p>I had just finished a project making a transcoding and multi-casting video server that involved
                getting deep and dirty with edge-triggered asynchronous IO in C++ (the server got open-sourced as <a href="post/18200335569.html" target="_blank">hellepoll</a>
                afterwards), so I really was keen to <em>avoid</em> exactly that type of high-complexity
                solution.  I didn’t think this new project warranted it.</p>
                <p>So I opted for Python (it aligned with other teams in the company and to be honest I was
                willingly forced into using it) with Twisted (as Tornado was at the time very evolutionary and didn’t
                have all the utility DB stuff and so on).  I opted for MySQL too (as that was already in use in the
                company and that simplified the deploy story).</p>
                <p>You already know I’m going to tell you this was a mistake:</p>
                <p><!-- more --></p></post-body>
 <button class="page-link" onclick="window.location='classic.html#53349845356'">classic</button>  <button class="page-link" onclick="window.location='index2.html#53349845356'">index</button> 
<button class="page-link" onclick="window.location='post/53349845356.html'"><b>read&nbsp;more&nbsp;&rarr;</b></button>
    <span class="post-metadata"><i>posted 2013-06-19</i></span>
</div>

<div class="post">
<div class="maximize-post" onclick="window.location='post/35134924139.html'"><img src="static/icons/maximize-2.svg"/></div>
<a name="35134924139">
    <h2 onclick="window.location='post/35134924139.html'">A novel profiler for Python</h2>
</a>
<?xml version="1.0" ?><post-body><p><em><strong>UPDATE</strong></em>: now on <a href="https://github.com/williame/will_profile" target="_blank">github</a> with a <a href="https://williame.github.com/will_profile/example.html" target="_blank">clickable example</a>! 
                You can even use the <a href="https://williame.github.com/will_profile/will_profile.html" target="_blank">on-line viewer</a> for your own traces.</p>
                <p>At work, I’ve been trying to profile a very CPU-intensive part of a long-running
                Python server.</p>
                <p>There was a time, back in the dark ages, when randomly stopping your program in a debugger and
                memorising the stack trace was a perfectly respectable way to ‘profile’ your code!</p>
                <p>And it actually worked very well.  But somehow, with the advent of fancy profiling tools, the
                simple and robust approach became forgotten…</p>
                <p><a href="https://stackoverflow.com/questions/9819142/profiling-a-long-running-python-server" target="_blank">In order to profile my servers</a>, I’ve added the <a href="https://code.google.com/p/yappi/" target="_blank">yappi</a> profiler in such a way that it
                can be started and stopped via a debug HTTP interface.  So you can, remotely, turn on and off profiling
                and recover the log.</p>
                <p>This has worked better than nothing, but I’ve found it problematic; yappi - and other
                Python profilers - are so intrusive that they can slow the whole server down by nearly a factor of 3,
                and this can cause a whole cascade of timeouts and other problems which interfere with the path you are
                trying to profile.  Additionally, <em>interpreting</em> the output can be difficult.  The
                functions that glow most are the utility functions, and the actual what-your-application-is-doing feel
                just isn’t there.</p>
                <p>So, in desperation, this morning I made a full-stack-sampling profiler.  N-times a second it
                will save a snapshot of the current stack.  Sampling the stack, say, 10 times per second has no
                noticeable impact on run-time and doesn’t distort the program being profiled:</p>
                <p><img src="media/old/35134924139_1.jpg"/></p>
                <p><!-- more --></p></post-body>
 <button class="page-link" onclick="window.location='index3.html#35134924139'">index</button> 
<button class="page-link" onclick="window.location='post/35134924139.html'"><b>read&nbsp;more&nbsp;&rarr;</b></button>
    <span class="post-metadata"><i>posted 2012-11-06</i></span>
</div>

<div class="post">
<div class="maximize-post" onclick="window.location='post/26063783576.html'"><img src="static/icons/maximize-2.svg"/></div>
<a name="26063783576">
    <h2 onclick="window.location='post/26063783576.html'">LevelDB isn&#39;t the fastest kid in town</h2>
</a>
<?xml version="1.0" ?><post-body><p><a href="https://www.sqlite.org/src4/doc/trunk/www/index.wiki" target="_blank">SQLite4</a>
                <a href="https://www.sqlite.org/src4/doc/trunk/www/design.wiki" target="_blank">is faster</a>:</p>
                <blockquote>
                <p>The default built-in storage engine is a log-structured merge database. It is very fast, faster
                than LevelDB, supports nested transactions, and stores all content in a single disk file.</p>
                </blockquote>
                <p>How much faster, or faster <a href="https://stackoverflow.com/a/9819411/15721" target="_blank">for what</a> they don’t say.</p>
                <p>So this brings the speed demons to three:</p>
                <ul><li><a href="https://code.google.com/p/leveldb/" target="_blank">LevelDB</a>,
                a <a href="https://www.igvita.com/2012/02/06/sstable-and-log-structured-storage-leveldb/" target="_blank">log-structured merge</a> database</li>
                <li>SQLite4, with the default storage-engine which is a log-structured merge database too</li>
                <li><a href="http://www.tokutek.com/" target="_blank">TokuDB</a>, a <a href="http://www.tokutek.com/resources/technology/" target="_blank">fractal tree</a> database</li>
                </ul><p>It will of course be exciting to see how fast they actually are on realistic
                workloads.</p>
                <p>Wouldn’t it be nice if <em>all three</em> were storage engines for
                SQLite4?  Allowing for a good comparison to be made.</p>
                <p>Tokutek have a simple key-value store engine that seems to be close to a 1:1 match for slotting
                into SQLite4.</p>
                <p>What’s exciting you the storage engine front?</p>
            </post-body>
 <button class="page-link" onclick="window.location='db.html#26063783576'">db</button>  <button class="page-link" onclick="window.location='index3.html#26063783576'">index</button> 

    <span class="post-metadata"><i>posted 2012-06-28</i></span>
</div>

<div class="post">
<div class="maximize-post" onclick="window.location='post/25080396258.html'"><img src="static/icons/maximize-2.svg"/></div>
<a name="25080396258">
    <h2 onclick="window.location='post/25080396258.html'">Oh MySQL I hate you</h2>
</a>
<?xml version="1.0" ?><post-body><p>Top 5 lists are super-good link bait, so I’ll make my own sad one.</p>
                <p>In no particular order, and not stopping at 5:</p>
                <ol><li>your table names are <a href="https://dev.mysql.com/doc/refman/5.0/en/identifier-case-sensitivity.html" target="_blank">case-sensitive
                on some platforms</a> (and, on some platforms, dependent on file system type!) but not others</li>
                <li>data definitions (DDL) <a href="https://stackoverflow.com/a/687006/15721" target="_blank">are
                not</a> in transactions</li>
                <li>you don’t have a transaction-safe <a href="https://dev.mysql.com/doc/refman/5.0/en/memory-storage-engine.html" target="_blank">memory</a>
                table (so create them temporarily for each connection, and clear them manually on rollback)</li>
                <li><!-- more --></li></ol></post-body>
 <button class="page-link" onclick="window.location='db.html#25080396258'">db</button>  <button class="page-link" onclick="window.location='classic.html#25080396258'">classic</button>  <button class="page-link" onclick="window.location='index4.html#25080396258'">index</button> 
<button class="page-link" onclick="window.location='post/25080396258.html'"><b>read&nbsp;more&nbsp;&rarr;</b></button>
    <span class="post-metadata"><i>posted 2012-06-14</i></span>
</div>

<div class="post">
<div class="maximize-post" onclick="window.location='post/19346002203.html'"><img src="static/icons/maximize-2.svg"/></div>
<a name="19346002203">
    <h2 onclick="window.location='post/19346002203.html'">How I got massively faster DB with in-process replication</h2>
</a>
<?xml version="1.0" ?><post-body><p>In my essay <a href="post/16516763725.html" target="_blank">How I got massively faster DB with async batching</a> I described how to make a
                <em>write</em>-heavy database web-app go fast.  In this essay I will describe a technique I
                touched on which makes <em><strong>read-heavy</strong></em> database web-apps go
                fast!</p>
                <p>Most normal corporate database web apps are either blazingly fast or blazingly slow at the five
                week mark; either nobody is using them hence they are blazingly fast, or everyone is using them hence
                they are blazingly slow.</p>
                <p>This is because the straightforward way to connect a database to a web app is naive.</p>
                <p><!-- more --></p></post-body>
 <button class="page-link" onclick="window.location='db.html#19346002203'">db</button>  <button class="page-link" onclick="window.location='index4.html#19346002203'">index</button> 
<button class="page-link" onclick="window.location='post/19346002203.html'"><b>read&nbsp;more&nbsp;&rarr;</b></button>
    <span class="post-metadata"><i>posted 2012-03-15</i></span>
</div>

<div class="post">
<div class="maximize-post" onclick="window.location='post/16516763725.html'"><img src="static/icons/maximize-2.svg"/></div>
<a name="16516763725">
    <h2 onclick="window.location='post/16516763725.html'">How I got massively faster DB with async batching</h2>
</a>
<?xml version="1.0" ?><post-body><p>As said in my <a href="post/16399069781.html" target="_self">moreSQL</a>
                article:</p>
                <blockquote>
                <p><big>I found databases to be fastest when my own code buffers DB interaction and reorders
                things and coalesces things so the DB is getting a few queries each with more payload.</big></p>
                </blockquote>
                <p>And I was rather disillusioned with ORMs.</p>
                <p>ORMs are about fast-prototyping code.  However, I discovered - in my DB usage patterns - that
                it was extra development cost when we discovered that the performance cost was prohibitive we had to
                chop it all out and replace it with a custom pattern.  It would have been massively faster development
                to just have done DB asynchronous in the first place…</p>
                <p>What I built is so generally applicable I offer it here as a useful pattern for your projects
                when you hit the same scaling issues we did:</p>
                <!-- more --></post-body>
 <button class="page-link" onclick="window.location='db.html#16516763725'">db</button>  <button class="page-link" onclick="window.location='classic.html#16516763725'">classic</button>  <button class="page-link" onclick="window.location='index5.html#16516763725'">index</button> 
<button class="page-link" onclick="window.location='post/16516763725.html'"><b>read&nbsp;more&nbsp;&rarr;</b></button>
    <span class="post-metadata"><i>posted 2012-01-26</i></span>
</div>

<div class="post">
<div class="maximize-post" onclick="window.location='post/16399069781.html'"><img src="static/icons/maximize-2.svg"/></div>
<a name="16399069781">
    <h2 onclick="window.location='post/16399069781.html'">Google: MoreSQL is Real</h2>
</a>
<?xml version="1.0" ?><post-body><p><img align="left" alt="dead link: http://img197.imageshack.us/img197/959/moresql.png" height="75" src="/#404" width="257"/></p>
                <p>The post <a href="https://tatiyants.com/nosql-no-more-lets-double-down-with-moresql/" target="_blank">NoSQL no more: let’s double down with MoreSQL</a> is said
                tongue-in-cheek.  But its more true and serious and real than the NoSQL crowd want to admit.  And Alex
                made a sweet logo.</p>
                <!-- more --></post-body>
 <button class="page-link" onclick="window.location='db.html#16399069781'">db</button>  <button class="page-link" onclick="window.location='classic.html#16399069781'">classic</button>  <button class="page-link" onclick="window.location='index5.html#16399069781'">index</button> 
<button class="page-link" onclick="window.location='post/16399069781.html'"><b>read&nbsp;more&nbsp;&rarr;</b></button>
    <span class="post-metadata"><i>posted 2012-01-24</i></span>
</div>

<div class="post">
<div class="maximize-post" onclick="window.location='post/13590981677.html'"><img src="static/icons/maximize-2.svg"/></div>
<a name="13590981677">
    <h2 onclick="window.location='post/13590981677.html'">Performance lessons for HTTP sockets</h2>
</a>
<?xml version="1.0" ?><post-body><p><a href="https://github.com/williame/hellepoll" target="_blank" title="hellepoll">hellepoll</a>
                is a fast little webserver that I’ve made.  I’ve written a few little custom event
                loops like this over the years; this isn’t the first, and likely not the last.</p>
                <p>In the tightest HTTP handling code you have to handle pipelining and flushing.  This is the
                hellepoll secret:</p>
                <p><!-- more --></p></post-body>
 <button class="page-link" onclick="window.location='index5.html#13590981677'">index</button> 
<button class="page-link" onclick="window.location='post/13590981677.html'"><b>read&nbsp;more&nbsp;&rarr;</b></button>
    <span class="post-metadata"><i>posted 2011-12-01</i></span>
</div>

<div class="post">
<div class="maximize-post" onclick="window.location='post/13363076806.html'"><img src="static/icons/maximize-2.svg"/></div>
<a name="13363076806">
    <h2 onclick="window.location='post/13363076806.html'">Buffcacher</h2>
</a>
<?xml version="1.0" ?><post-body><p>What should a ‘cache’ be? It means a lot of things, but to my
                mind the default programming type should be:</p>
                <p><big>“<em>keep around expensive-to-generate bits of read-only data in
                case we need them again, or until the computer really needs that RAM for something else</em>”</big></p>
                <p>I was writing a custom video editing program in Python (interesting choice of language for that
                problem) and I wanted to cache decoded frames; but I just wasn’t happy with the memory
                management of explicit caches.  It means making a decision about how much RAM to ring-fence for
                something without having global system knowledge.</p>
                <p>The problem with most caching systems is they aren’t elastic and they don’t
                dynamically reflect the demands of other applications you are sharing a computer with.  Additionally, in
                my case, I wanted it to work multi-process too.</p>
                <p>Python has weak references but they are something else; you have to keep a strong reference to
                something to keep it around.</p>
                <p>Java has soft references for caching purposes but they are objects living in the small bit of
                your RAM assigned to your JVM.</p>
                <p>My inspiration was the <em><strong>Operating System File System’s “Buffer
                Cache”</strong></em>:</p>
                <p>All mainstream OSes have much the same strategy - unused pages of RAM are used to cache disk IO
                automatically. If your application is reading and/or writing to the same bits of a file, its likely
                getting reads back straight from the OS 'buffer cache’ without hitting disk. And this happens
                much more than you think, since all the code and libraries are, at this level, just files too.</p>
                <p>Imagine you could share that buffer cache?  Imagine you could write data that the <em>kernel</em>
                only kept around if it didn’t have a better use for it?  And imagine you could share the reads
                and writes between processes too if you wanted?  And the kernel had a way of managing permissions,
                locking and sharing.</p>
                <p>So I made a quick and dirty filesystem to (ab)use the OS VM system for the caching of arbitrary
                objects without them writing through to file. As the buffer cache sits in front of the filesystem, the
                filesystem’s reading and writing can look like this:</p>
                <pre><code>int read(file*, offset, length, bytes*):
                return -EIO; # report an error
                int write(file*, offset, length, bytes*):
                return length; # report success, but don't store the bytes anywhere</code></pre>
                <p>Now its a case of tracking where you have written your cached items to in some file on this
                filesystem, and if your reading back of the cached value at some later time succeeds, those bytes were
                read from the OS’s cached pages!</p>
                <p>In this way its easy to cache items in the OS and let them compete for free RAM with the IO
                pages. As caching is diminishing returns, there’s likely plenty of free RAM to store the hot
                IO and these cached values, with the remainder of free RAM churning with the speculative storing of
                soon-discarded cold pages of things.</p>
                <p>It would be a worthwhile finesse to regularly sort popular small items to be near to each
                sharing pages, but I took the easy way out and aligned all items on page boundaries; after all,
                uncompressed video frames are several pages each anyway.</p>
                <p>I used FUSE to get this working. But it was quite slow. Unfair to say was <em>extremely</em>
                slow, since, it was <strong><em>faster</em></strong> than <strong>memcached</strong>
                running on the same machine :)</p>
                <p>But <em><strong>imagine a kernel module filesystem</strong></em> to do
                this… that’d be blazingly fast. The key lookup could be inside the kernel too; I
                could imagine a lookup being a dreaded <code>ioctl</code> that returned the file offset and
                length of items or reserved for storing new items. And if the read hits the filesystem callback, it
                could check to see if its a miss or if the filesystem itself explicitly evicted the value since it has
                been replaced by another value in since the offset/length was fetched with the ioctl; in this way,
                multiple users could use the same store (perfect for forking and other cooperative things; what would
                your gnome or KDE want to cache that wasn’t naturally a file?). <em>How fast</em>
                might a kernel module be? Its the same as a RAM disk, basically. That’s <em>fast</em>
                :)</p>
                <p>You could go further; if you are using some <strong>NoSQL</strong> server, or even
                memcached, you likely have it on another node. As sets are a fraction of the gets, you could have a
                single thread on each client that listens to the NoSQL server for the hashcodes of set keys, and invokes
                some ioctl that invalidates them in the common cache. This way, all your redis or whatever reads on each
                of your webserver nodes could be cached locally.</p>
                <p>Or you could take a classic cache like memcached, that itself could use buffcacher instead of
                doing its own eviction policy and using a static amount of resources on each node.</p>
                <p>I wish that all operating systems had a straightforward, even standardised, way to cache data
                in  a dynamic way.  And I wish that all programming languages came with standard libraries to utilise
                it.</p>
                <p>Whilst programs are not particularly getting larger, the data they act upon is.  The future
                will be full of data, and it’ll be increasingly important to compress that data on storage, as
                storage is not getting faster even as it gets bigger.</p>
                <p>I philosophised on whether my buffercacher is the first step towards proper explicit OS support
                for this; after reflection I decided that yes, <em>files</em> are good abstraction for
                this.  The OS doesn’t need to learn new tricks, it just needs a file system that is
                forgetful.  A good library can do the rest.  Just as long as its installed by default ;)</p>
                <p><strong>Your browser probably reserves 60% or so of your RAM</strong> just to fill
                up with pages you’ve visited or might soon visit.  (There’s so much wrong with that
                statement but its true <em>in spirit</em>.)  This is because there isn’t a
                system-wide caching system it can use.  It ought to be using buffcacher!</p>
            </post-body>
 <button class="page-link" onclick="window.location='index5.html#13363076806'">index</button> 

    <span class="post-metadata"><i>posted 2011-11-26</i></span>
</div>


    

</div>


<div class="column">
    <div class="page-map">
        <h1 style="text-align: center">jump to &darr;</h1>
        <hr/>
        
            <div class="page-link" onclick="window.location='index.html'">main&nbsp;page&nbsp;&uarr;</div>
            <hr/>
        
        
            


        
            

    <div class="page-map-branch">
    <b>performance</b>
        
            <img class="feather" src="static/icons/bar-chart-2.svg"/>
        
        
            <div class="page-map-section">
            
                
                    <div class="page-map-leaf" onclick="window.location='post/172424230628.html'">Faster searches with non-prefix fields in composite indices</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/160628887798.html'">Compressing MySQL databases</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/53836725910.html'">What highscalability.com says about Scaling my Server</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/53751799442.html'">Scaling my Server: follow-up</div>
                
            
                
                    <div class="page-link" onclick="window.location='perf.html'">more&nbsp;&rarr;</div>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
            </div>
        
    </div>


        
            

    <div class="page-map-branch">
    <b>old classics</b>
        
            <img class="feather" src="static/icons/book-open.svg"/>
        
        
            <div class="page-map-section">
            
                
                    <div class="page-map-leaf" onclick="window.location='post/49786413417.html'">The kid&#39;s computer</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/37291851878.html'">Making the History of Worlds Religions map</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/25564136097.html'">If you defend those involved in the OpenGL ES specification, you are an idiot</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/25426541504.html'">Stackoverflow unwinding?</div>
                
            
                
                    <div class="page-link" onclick="window.location='classic.html'">more&nbsp;&rarr;</div>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
            </div>
        
    </div>


        
            

    <div class="page-map-branch">
    <b>general</b>
        
            <img class="feather" src="static/icons/terminal.svg"/>
        
        
            <div class="page-map-section">
            
                
                    <div class="page-map-leaf" onclick="window.location='post/134911547413.html'">Why Swift?</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/94734034483.html'">Python annotations and type checking</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/86488099258.html'">pycon 2014 Sweden: the bad bits</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/78636919764.html'">Table-based Template Translation in C++</div>
                
            
                
                    <div class="page-link" onclick="window.location='lang.html'">more&nbsp;&rarr;</div>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
            </div>
        
    </div>


        
            

    <div class="page-map-branch">
    <b>recreation</b>
        
            <img class="feather" src="static/icons/youtube.svg"/>
        
        
            <div class="page-link" onclick="window.location='rec.html'">all&nbsp;&rarr;</div>
            <div class="page-map-section">
            
                

    <div class="page-map-branch">
    <b>games programming</b>
        
            <img class="feather" src="static/icons/play.svg"/>
        
        
            <div class="page-map-section">
            
                
                    <div class="page-map-leaf" onclick="window.location='post/57140204975.html'">Perlin Noise</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/57181055984.html'">Perlin Noise</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/53831974133.html'">Drawing RTS maps fast</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/49797579721.html'">WillCity update</div>
                
            
                
                    <div class="page-link" onclick="window.location='game.html'">more&nbsp;&rarr;</div>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
            </div>
        
    </div>


            
                

    <div class="page-map-branch">
    <b>ludum-dare</b>
        
        
            <div class="page-map-section">
            
                
                    <div class="page-map-leaf" onclick="window.location='post/143376853353.html'">Ludum Dare #35 Mosaic</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/127137593983.html'">LudumDare 33 wallpapers</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/117234199303.html'">SSIM vs MSE for Mosaics</div>
                
            
                
                    <div class="page-map-leaf" onclick="window.location='post/97634254788.html'">Ludum Dare 30 results are in!</div>
                
            
                
                    <div class="page-link" onclick="window.location='ludum-dare.html'">more&nbsp;&rarr;</div>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
            </div>
        
    </div>


            
            </div>
        
    </div>


        
        
    </div>
</div>
</div>
</body>
</html>